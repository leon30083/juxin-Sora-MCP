# 《标准开发文档》（严格遵循 MCP 标准，修正角色创建为视频）

## 需求解读
- 目标：实现一个 MCP Server，封装聚鑫 Sora 2 的“创建角色 / 生成视频 / 查询任务”三类能力，供 AI 助手调用。
- 范围：仅对接“统一视频格式”接口，以保证与角色创建的参数兼容。

## 权威规范与引用（MCP）
- Tools 规范（输入 / 输出 / 结构化结果 / 错误）：https://modelcontextprotocol.io/specification/draft/server/tools
- Overview 与消息模型（JSON-RPC 2.0 / 错误码规则）：https://modelcontextprotocol.io/specification/2025-06-18/basic
- Schema Reference（工具 annotations / outputSchema / 结果承载）：https://modelcontextprotocol.io/specification/2025-06-18/schema
- 架构总览（传输 / 授权 / 工具注册与通知）：https://modelcontextprotocol.io/docs/learn/architecture

## 权威文档与引用（业务接口）
- 接入点与鉴权：[代理接口调用地址](https://juxinapi.apifox.cn/doc-7302533.md)
- 状态码说明：[状态码说明](https://juxinapi.apifox.cn/doc-7487474.md)
- 创建角色（以视频为参考）：[sora 视频生成 > 创建角色](https://juxinapi.apifox.cn/api-377800347.md)
- 创建视频（纯提示）：[sora-2](https://juxinapi.apifox.cn/api-360463275.md) / [sora-2-pro](https://juxinapi.apifox.cn/api-377800348.md)
- 创建视频（带角色）：[统一视频格式 > 创建视频（带 Character）](https://juxinapi.apifox.cn/api-377800349.md)
- 查询任务：[统一视频格式 > 查询任务](https://juxinapi.apifox.cn/api-358967589.md)

## MCP 合规点
- JSON-RPC 2.0；`tools/list` 暴露工具，`tools/call` 调用工具。
- 所有工具声明 `inputSchema`（Draft-07）与 `outputSchema`。
- 返回包含 `structuredContent` 与文本 JSON 序列化（向后兼容）。
- 工具级错误：`isError: true`，`code` 为整数，`message` 为字符串。

## 工具设计（最终版）

### Tool A：`create_character`
- 描述：上传参考视频并注册为“角色”，返回 `character_id`。
- 输入：`video_url` 或 `video_base64` 二选一必填；`timestamps` 建议提供；工具内部先将素材归一为聚鑫图床 URL。
- 输出：`character_id`；`reference_video_url`（图床URL）。
- 路径：`POST /sora/v1/characters`

### Tool B：`generate_video`
- 描述：生成视频（纯提示词或角色驱动）。
- 输入：`prompt`、`model` 必填；`images`、`character_url`、`character_timestamps`、`duration`、`size` 等按统一视频格式；素材均先上传至图床。
- 角色驱动：使用 `character_url` 与 `character_timestamps`；
- 路径：`POST /v1/video/create`（`sora-2-pro` 同路径，字段区分）。
- 输出：`task_id`。

### Tool C：`get_task_status`
- 描述：查询任务状态与结果链接。
- 输入：`task_id`。
- 输出：`status`（`pending`/`processing`/`succeeded`/`failed`）、`progress`（百分比）、`video_url`、`error_code`、`error_message`。

### Tool D：`generate_and_follow`
- 描述：创建并自动轮询直到返回 `video_url`。
- 输入：同 `generate_video`；轮询参数 `poll_interval_seconds`（默认 6）、`max_minutes`（默认 8）。
- 输出：`task_id`、`final_status`、`video_url`、`updates[]`。

## 流程与治理
- 角色创建（参考视频，经图床）→ 生成视频（素材归一后提交）→ 查询任务/自动轮询直至 `video_url`。
- 安全：环境变量注入；不记录密钥；错误与日志脱敏；素材统一图床管理。
- 错误治理：工具级错误返回；429/5xx 退避重试；4xx 参数错误直接提示。

## 测试与验证
- 单测：Schema 校验、模式分流、错误映射。
- 集成：端到端（创建 → 生成 → 查询），覆盖成功与失败路径。
- 结构化输出：确保 `structuredContent` 与文本 JSON 同步。
